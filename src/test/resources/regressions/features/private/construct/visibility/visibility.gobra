package visibility

type Visibility struct {
  // Public fields
  PubInt int

  // Private fields
  pvtInt int
}

pred (vis *Visibility) PvtMem() {
  acc(&vis.pvtInt)
}

requires vis.PvtMem()
pure func (vis *Visibility) GetPvtInt() int {
  return unfolding vis.PvtMem() in vis.pvtInt
}


ensures acc(&result.PubInt) && result.PvtMem() && result.IsPvtEmpty()
ensures result.PubInt == value.PubInt
ensures result.IsPvtEmpty()
construct &Visibility() {
  fold result.PvtMem()
}

requires vis.PvtMem()
ensures res == (vis.GetPvtInt() == 0)
pure func (vis *Visibility) IsPvtEmpty() (res bool) {
  return unfolding vis.PvtMem() in vis.pvtInt == 0 
}

requires acc(&vis.PubInt) && vis.PvtMem()
requires vis.PubInt == 0 
requires vis.IsPvtEmpty()
ensures acc(&vis.PubInt) && vis.PvtMem()
ensures vis.PubInt == 1 
ensures vis.IsPvtEmpty()
private {
  requires acc(vis)
  requires vis.PubInt == 0 
  requires vis.pvtInt == 0 
  ensures acc(vis)
  ensures vis.PubInt == 1 
  ensures vis.pvtInt == 0 
  proof {
    unfold vis.PvtMem()
    Start(vis)
    fold vis.PvtMem()
  }
}
func Start(vis *Visibility) {
  if (vis.pvtInt == vis.PubInt) {
    vis.PubInt += 1
  }
}

requires acc(&vis.PubInt) && vis.PvtMem()
ensures acc(&vis.PubInt) && vis.PvtMem()
ensures vis.PubInt == old(vis.PubInt) + 1 && vis.GetPvtInt() == old(vis.PubInt)
private {
  requires acc(vis)
  ensures acc(vis)
  ensures vis.PubInt == old(vis.PubInt) + 1 && vis.pvtInt == old(vis.PubInt)
  proof {
    unfold vis.PvtMem()
    Next(vis)
    fold vis.PvtMem()
  }
}
func Next(vis *Visibility) {
  vis.pvtInt = vis.PubInt
  vis.PubInt += 1
}

requires acc(&vis.PubInt) && vis.PvtMem()
ensures acc(&vis.PubInt) && vis.PvtMem()
ensures vis.PubInt == old(vis.GetPvtInt())
ensures vis.GetPvtInt() == old(vis.GetPvtInt()) - (old(vis.GetPvtInt()) > 0 ? 1 : 0)
private {
  requires acc(vis)
  ensures acc(vis)
  ensures vis.PubInt == old(vis.pvtInt)
  ensures vis.pvtInt == old(vis.pvtInt) - (old(vis.pvtInt) > 0 ? 1 : 0)
  proof {
    unfold vis.PvtMem()
    Reload(vis)
    fold vis.PvtMem()
  }
}
func Reload(vis *Visibility) {
  vis.PubInt = vis.pvtInt
  if (vis.pvtInt > 0) {
    vis.pvtInt = vis.pvtInt - 1
  }
}

func client() {
  v := &Visibility{PubInt: 0, pvtInt: 0} //constructor is not called here
  assert acc(v) && v.PubInt == 0 && v.pvtInt == 0

  Start(v) //start uses the private specification, only permission to the fields of Visibility needed
  assert acc(v) && v.PubInt == 1 && v.pvtInt == 0
  
  Next(v)
  assert acc(v) && v.PubInt == 2 && v.pvtInt == 1
  
  Next(v)
  assert acc(v) && v.PubInt == 3 && v.pvtInt == 2
  
  Reload(v)
  assert acc(v) && v.PubInt == 2 && v.pvtInt == 1
  
  Reload(v)
  assert acc(v) && v.PubInt == 1 && v.pvtInt == 0
  
  Reload(v)
  assert acc(v) && v.PubInt == 0 && v.pvtInt == 0
  
  Reload(v)
  assert acc(v) && v.PubInt == 0 && v.pvtInt == 0

  fold v.PvtMem() //IsPvtEmpty() uses the private memory predicate
  assert v.IsPvtEmpty()
  unfold v.PvtMem()

  Next(v) //just like Start(v), next uses the private specification
  assert acc(v) && v.PubInt == 1 && v.pvtInt == 0
 
  fold v.PvtMem() //IsPvtEmpty() uses the private memory predicate
  assert !v.IsPvtEmpty() && v.PubInt == 1
}
